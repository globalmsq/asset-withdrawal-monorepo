# 블록체인 출금 시스템 - 제품 요구사항 문서 (PRD)

## 프로젝트 개요

자산 출금 시스템은 **Polygon 네트워크 전용** 암호화폐 출금 플랫폼입니다. 마이크로서비스 아키텍처와 큐 기반 비동기 처리를 통해 안전하고 확장 가능한 출금 서비스를 제공합니다.

### 핵심 목표
- **완전한 출금 플로우 구현**: API 요청 → 서명 → 브로드캐스트 → 모니터링
- **보안 우선**: AWS Secrets Manager + AES-256-GCM 이중 암호화
- **확장성**: Redis 기반 nonce 관리, SQS 큐 시스템
- **운영성**: Admin 페이지를 통한 시스템 관리

## 현재 구현 상태

### ✅ 완료된 기능

#### 핵심 서비스
- **API 서버** (api-server): REST API, Swagger 문서, 출금 요청/상태 조회
- **서명 서비스** (signing-service): 트랜잭션 서명, Redis 기반 nonce 관리, 가스 가격 캐싱
- **큐 시스템**: LocalStack/AWS SQS 통합, 다중 큐 지원, 오류 처리

#### 데이터베이스 & 보안
- **데이터베이스**: WithdrawalRequest, Transaction, SignedTransaction 모델
- **보안**: AWS Secrets Manager + AES-256-GCM 개인키 암호화
- **인프라**: Docker Compose, Redis, MySQL, LocalStack

#### 핵심 기술적 성취
- **Redis 기반 Nonce 관리**: 원자적 연산으로 트랜잭션 충돌 방지
- **가스 가격 캐싱**: 30초 TTL로 RPC 호출 최적화
- **서명된 트랜잭션 추적**: 완전한 감사 추적 및 재시도 관리

### ❌ 미구현 기능 (우선순위순)

1. **tx-broadcaster** ⚠️ **긴급**: 서명된 트랜잭션을 블록체인에 브로드캐스트
2. **DLQ 핸들러**: 실패한 메시지 처리 및 복구
3. **실제 잔액 검증**: signing-service에서 토큰 잔액 확인
4. **Admin API + 인증**: 트랜잭션 관리, 시스템 모니터링, JWT 인증
5. **모니터링 시스템**: Prometheus/Grafana, 알림 시스템

## 시스템 아키텍처

### 마이크로서비스 흐름
```
[사용자] → [api-server] → [tx-request-queue] → [signing-service] → [signed-tx-queue] → [tx-broadcaster] → [Polygon 블록체인]
                                                                                                    ↓
                                                                                            [tx-monitor]
```

### 핵심 구성요소
1. **api-server**: HTTP API, 요청 검증, 데이터베이스 저장
2. **signing-service**: 트랜잭션 서명, nonce 관리, 가스 가격 최적화
3. **tx-broadcaster**: 블록체인 브로드캐스트, 재시도 로직 (⚠️ 미구현)
4. **tx-monitor**: 트랜잭션 확인 추적, 상태 업데이트 (⚠️ 미구현)

### 기술 스택
- **런타임**: Node.js 18+ + TypeScript
- **프레임워크**: Express.js, Nx 모노레포
- **데이터베이스**: MySQL + Prisma ORM
- **큐**: AWS SQS / LocalStack
- **캐시**: Redis (nonce, 가스 가격)
- **블록체인**: Polygon (Amoy 테스트넷), Ethers.js v6
- **보안**: AWS Secrets Manager, AES-256-GCM

## 개발 로드맵

### Phase 1: 핵심 시스템 완성 (긴급)

#### 1.1 tx-broadcaster 구현 ⚠️ **최우선**
```typescript
// 필수 기능
- signed-tx-queue에서 메시지 폴링
- 데이터베이스에서 서명된 트랜잭션 조회
- Polygon 네트워크에 브로드캐스트
- 트랜잭션 상태 업데이트 (BROADCASTED → CONFIRMED)
- nonce 충돌 감지 및 재동기화
- 실패 시 재시도 로직 및 DLQ 처리
```

#### 1.2 DLQ 핸들러 구현
```typescript
// 기능
- 실패 메시지 분류 (영구적 vs 일시적)
- 재시도 자격 판단
- 수동 개입 알림
- 메시지 재처리 API
```

#### 1.3 실제 잔액 검증
```typescript
// signing-service 강화
- ERC-20 토큰 잔액 확인
- 가스 수수료 계산 및 검증
- 출금 한도 확인
- Redis 캐시를 통한 성능 최적화
```

### Phase 2: 관리 시스템

#### 2.1 Admin API + 인증 시스템
```typescript
// 인증 엔드포인트
POST /auth/register - 사용자 등록
POST /auth/login - JWT 로그인
POST /auth/refresh - 토큰 갱신

// Admin API (인증 필요)
GET /admin/transactions - 트랜잭션 목록/검색
GET /admin/queues - 큐 상태 모니터링
POST /admin/transactions/:id/retry - 수동 재시도
GET /admin/stats - 시스템 통계

// 주요 기능
- JWT 기반 인증 미들웨어
- 역할 기반 접근 제어 (USER, ADMIN)
- bcrypt 패스워드 해싱
- User 모델 및 서비스
```

#### 2.2 모니터링 시스템
- Prometheus 메트릭 수집
- Grafana 대시보드
- 알림 규칙 (큐 적체, 실패율 등)

### Phase 3: 프로덕션 준비

#### 3.1 보안 강화
- 속도 제한 (IP/사용자별)
- API 키 인증 시스템
- 보안 감사 및 침투 테스트

#### 3.2 인프라 마이그레이션
- AWS EKS 배포
- 자동 확장 설정
- 다중 AZ 배포

## 즉시 실행할 작업 (Critical Path)

### 1. tx-broadcaster 서비스 생성 ⚠️
```bash
nx g @nx/node:app tx-broadcaster
```

**핵심 구현 요소**:
- [ ] SQS 메시지 폴링 워커
- [ ] 서명된 트랜잭션 DB 조회
- [ ] Polygon 네트워크 브로드캐스트
- [ ] 트랜잭션 상태 업데이트
- [ ] 오류 처리 및 재시도 로직

### 2. 필수 테스트 케이스
- [ ] 정상 브로드캐스트 플로우
- [ ] nonce 충돌 시나리오
- [ ] RPC 실패 시나리오
- [ ] 재시도 한도 초과 시나리오

## 마일스톤

- **M1**: tx-broadcaster 구현으로 핵심 흐름 완성
- **M2**: tx-monitor, DLQ 핸들러 및 잔액 검증으로 안정성 확보
- **M3**: Admin API + 인증 시스템으로 관리 기반 확보
- **M4**: 모니터링 시스템으로 운영 효율성 확보
- **M5**: 프로덕션 배포 준비 완료

## 위험 관리

### 기술적 위험
1. **nonce 충돌**: ✅ Redis 원자적 연산으로 해결됨
2. **RPC 실패**: ✅ 가스 가격 캐싱 및 폴백으로 해결됨
3. **트랜잭션 실패**: tx-broadcaster에서 재시도 로직 필요

### 운영 위험
1. **대량 출금**: 큐 기반 부하 분산으로 대응
2. **시스템 장애**: 다중 AZ 배포 및 자동 복구 필요
3. **보안 위협**: 최소 권한 원칙, 정기 감사

## 성능 요구사항

### 목표 지표
- **트랜잭션 처리 시간**: < 30초 (end-to-end)
- **API 응답 시간**: < 200ms (p95)
- **처리량**: 100 TPS (초당 트랜잭션)
- **가용성**: 99.5% SLA
- **오류율**: < 0.1%

### 확장성 목표
- **일일 처리량**: 최대 100만 트랜잭션
- **동시 사용자**: 1,000명
- **큐 처리 속도**: 분당 1,000 트랜잭션

## 데이터 모델 (핵심)

### WithdrawalRequest ✅
```prisma
model WithdrawalRequest {
  id            BigInt   @id @default(autoincrement())
  requestId     String   @unique // tx-{timestamp}-{random}
  status        String   @default("PENDING") // PENDING → SIGNING → BROADCASTING → COMPLETED
  amount        String
  currency      String
  toAddress     String
  tokenAddress  String
  network       String
  errorMessage  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
```

### SignedTransaction ✅
```prisma
model SignedTransaction {
  id                    BigInt    @id @default(autoincrement())
  requestId             String    // WithdrawalRequest와 1:N 관계
  txHash                String
  nonce                 Int
  gasLimit              String
  maxFeePerGas          String?   // EIP-1559
  maxPriorityFeePerGas  String?
  from                  String
  to                    String
  value                 String
  chainId               Int
  retryCount            Int       @default(0)
  status                String    @default("SIGNED") // SIGNED → BROADCASTED → CONFIRMED
  signedAt              DateTime  @default(now())
  broadcastedAt         DateTime?
  confirmedAt           DateTime?
}
```

### User ❌ (Admin 개발시 구현 예정)
```prisma
model User {
  id        BigInt   @id @default(autoincrement())
  email     String   @unique
  password  String   // bcrypt 해시
  role      String   @default("USER") // USER, ADMIN
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}
```

## 개발 환경 설정

### 로컬 환경 시작
```bash
# 모든 서비스 시작
docker-compose -f docker/docker-compose.yaml up -d
docker-compose -f docker/docker-compose.localstack.yaml up -d

# SQS 큐 초기화
./docker/scripts/init-localstack.sh

# 개발 서버 시작
nx serve api-server
nx serve signing-service  # 별도 터미널
```

### 필수 환경 변수
```env
QUEUE_TYPE=localstack                    # 또는 'aws'
AWS_REGION=ap-northeast-2
POLYGON_RPC_URL=https://rpc-amoy.polygon.technology
POLYGON_CHAIN_ID=80002                   # Amoy 테스트넷
DATABASE_URL=mysql://root:password@localhost:3306/withdrawal_db
REDIS_URL=redis://localhost:6379
```

## 사용자 경험

### API 사용자 (개발자)
- **명확한 API 문서**: Swagger/OpenAPI 3.0 사양
- **일관된 에러 응답**: 
  ```json
  {
    "error": {
      "code": "INSUFFICIENT_BALANCE",
      "message": "잔액이 부족합니다",
      "retryable": false
    }
  }
  ```
- **재시도 정책**: 재시도 가능/불가능 에러 구분
- **샌드박스 환경**: Amoy 테스트넷 환경 제공

### 운영팀
- **실시간 대시보드**: Grafana 기반 시스템 모니터링
- **알림 설정**: 커스터마이징 가능한 알림 규칙
- **수동 개입 도구**: Admin API를 통한 수동 재시도, 상태 변경
- **감사 로그**: 모든 운영 작업 추적

## 비즈니스 컨텍스트

### Polygon 네트워크 선택 이유
- **낮은 가스비**: 이더리움 대비 1/100 수준
- **빠른 처리 속도**: 2초 블록 타임
- **이더리움 호환성**: 기존 도구 및 지식 활용 가능
- **안정성**: 대규모 트랜잭션 검증된 네트워크

### 향후 확장 계획
- **Phase 4**: Ethereum 메인넷 지원
- **Phase 5**: BSC, Arbitrum 지원
- **Phase 6**: 크로스체인 브릿지 통합

## 운영 요구사항

### 로깅
- **로그 레벨**: ERROR, WARN, INFO, DEBUG
- **구조화된 로그**: JSON 형식
- **필수 필드**: timestamp, correlationId, service, level, message
- **보존 기간**: 30일 (프로덕션), 7일 (개발)

### 알림
- **큐 적체**: > 1000개 메시지
- **에러율**: > 1% (5분 평균)
- **RPC 실패**: 연속 3회 이상
- **트랜잭션 실패**: 재시도 한도 초과
- **시스템 리소스**: CPU > 80%, 메모리 > 90%

### 모니터링 메트릭
- **비즈니스 메트릭**: 출금 요청 수, 성공률, 평균 처리 시간
- **시스템 메트릭**: CPU, 메모리, 네트워크 I/O
- **애플리케이션 메트릭**: API 응답 시간, 큐 깊이, 에러율

## 품질 보증

### 테스트 전략
- **단위 테스트**: 개별 서비스 로직 (커버리지 > 80%)
- **통합 테스트**: 서비스 간 통신
- **E2E 테스트**: 전체 출금 플로우
- **부하 테스트**: 목표 TPS 달성 확인
- **보안 테스트**: OWASP Top 10, 침투 테스트

### 보안 요구사항
- OWASP Top 10 준수
- 정기적인 코드 감사
- 침투 테스트 (프로덕션 전)
- 개인키 보안 (AWS Secrets Manager + AES-256-GCM)

## 배포 전략

### 단계별 배포
1. **개발 환경**: LocalStack + Docker Compose
2. **스테이징**: AWS SQS + RDS (테스트용)
3. **프로덕션**: EKS + Multi-AZ + 모니터링

### 롤백 계획
- Blue-Green 배포
- 데이터베이스 마이그레이션 롤백 스크립트
- 트랜잭션 상태 복구 도구

## 용어 정의

### 서비스 명칭
- **api-server**: HTTP API 게이트웨이
- **signing-service**: 트랜잭션 서명 서비스
- **tx-broadcaster**: 블록체인 브로드캐스트 서비스
- **tx-monitor**: 트랜잭션 모니터링 서비스

### 상태 정의
- **PENDING**: 초기 요청 상태
- **SIGNING**: 서명 진행 중
- **SIGNED**: 서명 완료
- **BROADCASTING**: 브로드캐스트 중
- **BROADCASTED**: 블록체인 전송 완료
- **CONFIRMING**: 확인 대기 중
- **CONFIRMED**: 최종 확인 완료
- **FAILED**: 처리 실패

---

**현재 최우선 과제**: tx-broadcaster 및 tx-monitor 구현을 통한 완전한 출금 플로우 완성

**프로젝트 목표**: 안전하고 확장 가능한 Polygon 네트워크 출금 시스템 구축

**관련 문서**: 
- 개발 계획: plan.md
- 시스템 아키텍처: ARCHITECTURE.md
- 설정 가이드: SETUP.md